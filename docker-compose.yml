services:
  openvpn-stats:
    build: .
    container_name: openvpn-stats
    restart: unless-stopped
#    ports:
#      - "5000:5000"
    volumes:
      - /var/log/openvpn:/var/log/openvpn:ro
      - ./data:/app/data
    environment:
      - FLASK_ENV=production
      - DB_PATH=/app/data/openvpn_stats.db
      - UPDATE_INTERVAL=60
      - SERVERS_CONFIG=
          office:/var/log/openvpn/status-openvpn.log:/var/log/openvpn/status-openvpn.log;
          office-full:/var/log/openvpn/status-openvpn-full.log:/var/log/openvpn/status-openvpn-full.log
      # Authentication (recommended for production)
      - AUTH_ENABLED=true                   # Включить авторизацию
      - AUTH_TOKEN=                         # Укажите свой токен здесь! (например: python3 -c "import secrets; print(secrets.token_urlsafe(32))")
      # Data retention
      - RETENTION_DAYS=90                    # Хранение сессий
      - TRAFFIC_HISTORY_RETENTION_DAYS=30   # Хранение трафика
      - DEFAULT_LIMIT=50                    # Лимит по умолчанию
      - MAX_LIMIT=500                       # Максимальный лимит

#      - OPENVPN_STATUS_FILE=/var/log/openvpn/status-openvpn.log
#      - OPENVPN_LOG_FILE=/var/log/openvpn/server-openvpn.log
    networks:
      - openvpn-stats-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  nginx:
    image: nginx:alpine
    container_name: openvpn-stats-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/sites-enabled:/etc/nginx/sites-enabled:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./nginx/.htpasswd:/etc/nginx/.htpasswd:ro
    depends_on:
      - openvpn-stats
    networks:
      - openvpn-stats-net
